<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gempire Discovery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #0b0e13;
      --panel: #111827;
      --card: #0f172a;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #6366f1;
      --link: #60a5fa;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .sub {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .search-bar {
      margin-top: 14px;
      display: flex;
      gap: 8px;
    }

    .search-bar input {
      flex: 1;
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
    }

    .search-bar button {
      padding: 10px 16px;
      background: var(--accent);
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .tabs {
      display: flex;
      gap: 16px;
      margin-top: 14px;
    }

    .tabs button {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      padding-bottom: 6px;
      border-bottom: 2px solid transparent;
    }

    .tabs button.active {
      color: white;
      border-color: var(--accent);
    }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 20px;
      padding: 20px 24px;
    }

    aside {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      height: fit-content;
    }

    aside h3 {
      margin-top: 0;
      font-size: 14px;
      margin-bottom: 10px;
    }

    aside label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    aside select,
    aside input[type="number"] {
      width: 100%;
      margin-top: 4px;
      padding: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
    }

    aside input[type="checkbox"] {
      margin-right: 6px;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .top-bar select {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 6px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      background: linear-gradient(180deg, #0f172a, #020617);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      position: relative;
      transition: transform 0.15s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card img {
      width: 100%;
      height: 260px;
      object-fit: contain;
      background: black;
      border-radius: 8px;
    }

    .heart {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 16px;
      color: #9ca3af;
      cursor: pointer;
    }

    .heart.active {
      color: #ef4444;
    }

    .title {
      font-size: 13px;
      margin-top: 8px;
      line-height: 1.3;
    }

    .price {
      font-weight: 600;
      margin-top: 6px;
    }

    .link {
      display: inline-block;
      margin-top: 6px;
      font-size: 13px;
      color: var(--link);
      text-decoration: none;
    }

    .status {
      text-align: center;
      color: var(--muted);
      padding: 20px;
    }
  </style>
</head>
<body>

<header>
  <h1>Gempire Discovery</h1>
  <div class="sub">Search Pokémon cards across eBay</div>

  <div class="search-bar">
    <input id="query" value="pokemon psa" />
    <button id="searchBtn">Search</button>
  </div>

  <div class="tabs">
    <button class="tab active" data-type="ALL">All Items</button>
    <button class="tab" data-type="AUCTION">Auctions</button>
    <button class="tab" data-type="FIXED">Fixed Price</button>
  </div>
</header>

<div class="layout">
  <aside>
    <h3>Filters</h3>

    <label>Grading</label>
    <select id="grading">
      <option value="">Any</option>
      <option>PSA</option>
      <option>BGS</option>
      <option>CGC</option>
    </select>

    <label>Grade</label>
    <select id="grade">
      <option value="">Any</option>
      <option>10</option>
      <option>9</option>
      <option>8</option>
    </select>

    <label>Min Price</label>
    <input type="number" id="minPrice" />

    <label>Max Price</label>
    <input type="number" id="maxPrice" />

    <label style="margin-top:12px;">
      <input type="checkbox" id="soldOnly" />
      Sold listings
    </label>
  </aside>

  <main>
    <div class="top-bar">
      <select id="sort">
        <option value="">Default</option>
        <option value="price">Price ↑</option>
        <option value="-price">Price ↓</option>
        <option value="endTime">Ending Soon</option>
      </select>
    </div>

    <div id="grid" class="grid"></div>
    <div id="status" class="status"></div>
    <div id="sentinel"></div>
  </main>
</div>

<script>
  const grid = document.getElementById('grid');
  const status = document.getElementById('status');
  const sentinel = document.getElementById('sentinel');

  let state = {
    q: '',
    offset: 0,
    limit: 24,
    total: null,
    loading: false,
    hasMore: true,
    sort: '',
    type: 'ALL',
    sold: false,
  };

  function reset() {
    state.offset = 0;
    state.total = null;
    state.hasMore = true;
    grid.innerHTML = '';
  }

  async function fetchItems(resetFetch = false) {
    if (state.loading) return;
    if (!state.hasMore && !resetFetch) return;

    state.loading = true;
    status.textContent = 'Loading…';

    if (resetFetch) reset();

    const params = new URLSearchParams({
      q: state.q,
      limit: state.limit,
      offset: state.offset
    });

    if (state.sort) params.set('sort', state.sort);
    if (state.type === 'AUCTION') params.append('filter', 'buyingOptions:{AUCTION}');
    if (state.type === 'FIXED') params.append('filter', 'buyingOptions:{FIXED_PRICE}');
    if (state.sold) params.append('filter', 'soldItemsOnly:true');

    const res = await fetch('/api/search?' + params.toString());
    const data = await res.json();

    const items = data.itemSummaries || [];

    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';

      const img = item.image?.imageUrl || '';
      card.innerHTML = `
        <div class="heart" data-id="${item.itemId}">♡</div>
        <img src="${img}" />
        <div class="title">${item.title}</div>
        <div class="price">$${item.price?.value || ''}</div>
        <a class="link" href="${item.itemWebUrl}" target="_blank">View on eBay</a>
      `;
      grid.appendChild(card);
    });

    state.offset += items.length;
    state.total = data.total;

    if (state.offset >= state.total) {
      state.hasMore = false;
      status.textContent = 'No more results';
    } else {
      status.textContent = '';
    }

    state.loading = false;
  }

  const observer = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) fetchItems();
  }, { rootMargin: '400px' });

  observer.observe(sentinel);

  document.getElementById('searchBtn').onclick = () => {
    state.q = document.getElementById('query').value;
    fetchItems(true);
  };

  document.getElementById('sort').onchange = e => {
    state.sort = e.target.value;
    fetchItems(true);
  };

  document.getElementById('soldOnly').onchange = e => {
    state.sold = e.target.checked;
    fetchItems(true);
  };

  document.querySelectorAll('.tab').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.type = btn.dataset.type;
      fetchItems(true);
    };
  });

  // initial load
  state.q = document.getElementById('query').value;
  fetchItems(true);
</script>

</body>
</html>
