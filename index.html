const state = {
  q: "pokemon psa",
  min: 0,
  max: 0,
  page: 1,
  sort: "newlyListed",
};

const resultsEl = document.getElementById("results");
const paginationEl = document.getElementById("pagination");
const minInput = document.getElementById("minPrice");
const maxInput = document.getElementById("maxPrice");

async function load() {
  resultsEl.innerHTML = "Loading...";
  paginationEl.innerHTML = "";

  const params = new URLSearchParams({
    q: state.q,
    min: state.min,
    max: state.max,
    page: state.page,
    sort: state.sort,
  });

  const res = await fetch(`/api/search?${params.toString()}`);
  const data = await res.json();

  if (!data.items.length) {
    resultsEl.innerHTML = "No results";
    return;
  }

  resultsEl.innerHTML = data.items
    .map(
      (i) => `
    <div class="card">
      <img src="${i.image}" loading="lazy" />
      <div class="title">${i.title}</div>
      <div class="price">$${i.price.toLocaleString()}</div>
      <a href="${i.link}" target="_blank">View</a>
    </div>
  `
    )
    .join("");

  renderPagination(data.total);
}

function renderPagination(total) {
  const pages = Math.ceil(total / 50);
  for (let i = 1; i <= Math.min(3, pages); i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => {
      state.page = i;
      load();
    };
    paginationEl.appendChild(btn);
  }

  const next = document.createElement("button");
  next.textContent = "Next";
  next.onclick = () => {
    state.page++;
    load();
  };
  paginationEl.appendChild(next);
}

document.getElementById("searchBtn").onclick = () => {
  state.q = document.getElementById("q").value;
  state.page = 1;
  load();
};

document.getElementById("applyFilters").onclick = () => {
  state.min = Number(minInput.value.replace(/,/g, "")) || 0;
  state.max = Number(maxInput.value.replace(/,/g, "")) || 0;
  state.page = 1;
  load();
};

document.getElementById("sort").onchange = (e) => {
  state.sort = e.target.value;
  state.page = 1;
  load();
};

window.onload = load;
